## WSagger 

### Поточний стан проєкту

Почав розроблятись як інструментарій для тестування socket.io-серверів, але виріс — тепер включає наступні можливості:

* запити до socket.io-серверів;
* запити до http/https; 
* консольний і браузерний інтерфейс;
* опис умов, за якими кожен крок виконання вважається успішним (виконання сценарію припиняється на першому неуспішному кроці);
* синхронне і/або асинхронне виконання породжених процесів (тільки в консольному інтерфейсі, поки що);
* комунікація між тестовими процесами (UNIX IPC, тільки в консольному інтерфейсі, поки що);
* виконання підпрограм (тільки в консольному інтерфейсі, поки що);
* завантаження файлів (зокрема, файлів-підпрограм) з диску (тільки в консольному інтерфейсі, поки що).

Оскільки підтримується виконання запитів до http/https, то зроблено конвертор swagger-файлів. Сценарії, отримані в результаті конвертації, скрізь, де це можливо, є двокроковими (щоб зменшити ручну роботу при тестуванні):

0. Спершу логін-авторизація
1. Потім REST-запит з токеном, отриманим на попередньому кроці.
   

### Функціонал в розробці 

* пакетний запуск сценаріїв (для автоматичного тестування; ще не перенесено з попередньої версії);
* верифікація сценаріїв згідно опису в форматі JSON Schema (ще не перенесено з попередньої версії); 
* вкладка "Scenarios tree" в браузерному інтерфейсі для швидкого доступу до сценаріїв;
* автоматична конвертація swagger-responses в expected-параметри сценаріїв (щоб максимально автоматизувати написання API-тестів).


### Браузерний інтерфейс

Запускається статичним index.html з кореня проєкту

Працює наступним чином:

0. В лівому вікні слід завантажити файл сценарію (по урлу або з диска). 

1. Додатково можна завантажити файл _variants.json з даними про сервери/користувачів для тестування (ці дані також можуть бути включені в сам сценарій). Поки ці дані  не завантажені, світиться повідомлення "No variants data (REST server, socket server, user, etc.) are loaded!!!"

2. При завантеженні http-сценаріїв всі варіянти responses (якущо вони описані в сценарії) доступні для перегляду на вкладці "Expectations".

3. При виконанні сценарію параметри визначаються наступним чином:

* спершу беруться значення defaultValue зі scenario.parameters_ (поза тим формат опису scenario.parameters_ співпадає з форматом parameters swagger);
* поверх них записуються дані з селекторів (селектори формуються згідно variants, див. п.1);
* і, нарешті, поверх усього записуються дані з тих полів форми, які заповнено користувачем.

4. Сценарій з так сформованими параметрами виконується, результати можна спостерігати в правому вікні.


### Приклади сценаріїв

~/examples/test_http_server_wsagger.json — тест на доступ до http-сторінки, успішно відпрацьовує, наприклад, при вводі

host: wsagger.dev.gbksoft.net
path: /
   


### Локальна установка і запуск з консолі

    $ git clone gogs@git.gbksoft.net:dzikovsky-po/wsagger.git
    $ cd wsagger
    $ npm install


Запуск сценарію на виконання: 

    ./w <filename> <server> <user> --debug 

Наприклад:

    ./w _tt/send_message.wsagger.json dev 1  --debug  
    

Параметри <server> і <user> — це ключі з обʼєктів, відповідно _variants.server_ і _variants.user_ у файлі сценарію.



### Формат опису сценаріїв

#### Поле wsagger

* "variants"   — означає, що в поточному файлі міститься дерево варіянтів (вибір сервера, користувача, протоколів тощо — для виконання поточного сценарію);
* "index"      — означає, що в поточному файлі міститься дерево сценаріїв (для вибору одного із);
* будь що инше — означає, що в поточному файлі міститься сценарій.
   

#### Поле origin

Інформація про сценарій, імпортована при конвертації swagger.json.


#### Поле name

Назва сценарію.
   

#### Поле _variants

Дерево варіянтів (вибір сервера, користувача, протоколів тощо — для виконання поточного сценарію) — те ж саме, що може міститись в окремому файлі _variants.json 
   

#### Поле parameters_

Опис параметрів, імпортований при конвертації swagger.json (або опис, зроблений в такому ж форматі) — використовується в браузерному інтерфейсі.
   

#### Поле responses

Опис результатів, імпортований при конвертації swagger.json (поки що не використовується, але відображаеться в браузерному інтерфейсі на закладці [Expectations]).


#### Поле data

Обʼєкт або список обʼєктів, кожен з яких може містити наступні поля:


##### Поле (data.)action

Можливі значення:

* "http.request"
* "https.request"
* "http_.request" (в цьому випадку першим параметром в списку data.data повинно йти або "http", або "https");
* "socket_io.connect"
* "socket_io.emit"
* "socket_io.expect"
   

##### Поле (data.)data

Обʼєкт або список обʼєктів, які передаються в якості параметрів для (data.)action.


##### Поле (data.)wait

{ "delay": ... } — час очікування в мілісекундах


##### Поле (data.)expected

Обʼєкт або список обʼєктів, які ми повинні бути отримані в результаті виконання сценарію (для http_ — один обʼєкт, для socket_io — може бути список):


### Обмін значеннями між сценарієм і контекстом.

Всі кроки одного сценарію виконуються в контексті певного обʼєкту. При виконанні сценарію в браузері початкові значення в полях контексту визначаються згідно parameters_, при виконанні з консолі — згідно консольних аргументів виклику.

При цьому в полях data і expected допустимо використовувати шаблони:

    {{key}}     // в цьому випадку робиться підставновка значення в поле сценарію із відповідного поля контесту

В полі expected також допустимо використовувати шаблони:
    
    {{!key}}    // в цьому випадку робиться підставновка значення з поле обʼєкта даних у відповідне поле контесту


### Опис доступів: _variants 


_variants  - должно быть в каждом файле?
при роботі з консолі — досить щоб воно було одне в поточному каталозі
при роботі з браузера — або воно є в файлі, або слід завантажити осібним кроком


   [http://wsagger.dev.gbksoft.net/_tt/login_and_connect.wsagger.json]
   [http://wsagger.dev.gbksoft.net/_tt_http/login.wsagger.json]
