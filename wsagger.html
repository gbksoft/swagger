<!doctype html>
<html>
  <head>
    <title>WSagger</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      
      #socketLog { list-style-type: none; margin: 0; padding: 0; }
      #socketLog li { padding: 5px 10px; }
      #socketLog li:nth-child(odd) { background: #eee; }
    
      #argumentum { position: absolute; left: 505px;}
      #titulus    { width: 500px; position: fixed; z-index:999; background-color:white; padding: 4px; }

    </style>
  </head>
  <body>
    
    <div id="titulus">
       <div id="status"></div>
       <table id="connect" width=300><tr><td>Token:</td><td align=right><input id="login"></td></tr>
          <tr><td colspan=2 align=center><input type="submit" style="width:300px;" value="Connect to WS" onclick="Connect(); return false;"></td></tr>
       </table>
       &nbsp;
       <p>User id: <span id="userId"></span>
       <p>Socket id: <span id="socketId"></span>
       <p>&nbsp;<br><span id="data"></span>

    </div>
    <div id="argumentum"><ul id="socketLog"></ul></div>

    </table>


    </form><table>
    
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
    
      var config = {{{frontConfigJson}}};      
      var data   = config.data;

      var text   = '', tryNum = 0, tryData = {};

      for (var k in data) {
         var scenarios = data[k].scenarios; delete data[k].scenarios;
         text += '<b>' + k + '</b>\n<p>' 
               +  JSON.stringify (data[k])
         ;
         for (var s_ in scenarios) {
            text += '<p>&nbsp;<br><font color=blue>' + s_ + '</font>\n<p>';
            
            var s = scenarios[s_];
            for (var v in s) {
               text += v + ': '+ JSON.stringify (s[v]) + '\n<br>';
            }

            tryData[++tryNum] = s.flow;
            text += '<button onclick="tryScenario ('+ tryNum + ')">Try!</button><br>\n';

         } 
      }
      
 

      setHTML ('data', text);

      var frontUrl = 'http://' + window.location.hostname + ':' + config.port + config.namespace;      
      var groupId  = '';
      var groups   = {};

      var socket, reload_, iam;

      function Connect () {
         if (iam) {
            notifyOnTop ('Друга спроба конекту неможлива :-( Треба перезавантажити сторінку', red);
            return
         }

         iam = true;

         var el       = document.getElementById ("login");
         var login    = el.value;

         var query = {query: "token=" + login};
         socket    = io (frontUrl, query);

         if (socket) {
   
            var onevent = socket.onevent;
            socket.onevent = function (packet) {
               var args = packet.data || [];
               onevent.call (this, packet);    // original call
               packet.data = ["*"].concat(args);
               onevent.call (this, packet);      // additional call to catch-all
            };
           
            socket
               .on ("*", function (event, data) {
                  showMessage ('in: ' + event + ' / ' + JSON.stringify (data), 'socketLog', 'green'); 
               })
               .on ('connected',   onConnected)
               .on ('serverError', onServerError)
            ;
            
            reload_ = config.autoreload ? window.setTimeout (function () { location.reload (); }, 2000) : undefined;
   
            socket.on ('connect', function () { 
               if (socket.connected) {
                  if (reload_) window.clearTimeout (reload_);
                  notifyOnTop ('Socket connected to ' + frontUrl, 'green');
                  setHTML ('connect', ''); 

               } else {
                  notifyOnTop("New socket is disconnected :-(", 'red'); 

               }
            });
            socket.on ('error',      function () { notifyOnTop ('status', "Error connecting to socket", 'red'); });
            socket.on ('disconnect', function () { notifyOnTop ("Socket is disconnected",               'red'); });
            
         } else {
            notifyOnTop ("Can't connect to socket", 'red'); 

         }   
      }

      function tryScenario (tryNum) {
         if (!socket) return;
         var flow = array_ (tryData[tryNum]);
         log (flow);
         for (var step of flow) {
            if (step[0] === 'request') {
                showMessage ('out: ' + step[1] + ' / ' + JSON.stringify (step[2]), 'socketLog', 'brown'); 
                socket.emit (step[1], step[2]);
            }
         }
      } 

      function onConnected (message) { 
         if (message.userId)   { setHTML ('userId', (userId = message.userId)); } 
         if (message.socketId) { setHTML ('socketId', message.socketId); }         

      }

      function onServerError (message) { 
         if (message.error) { notifyOnTop (message.error, 'red'); }
      }


      function setHTML (id, html) { 
         if (el = document.getElementById(id)) el.innerHTML = html; 
      }

      function notifyOnTop (message, color) {
         var text = (message && (typeof message == 'object')) ? JSON.stringify (message) : message;
         setHTML ('status', color ? '<font color = "' + color + '">' + text + '</font>' : text); 
      }

      function showMessage (text, type, color) {
         if (color) { $ ('#' + type).append ($ ('<li>').text (text).css ('color', color)); }
         else       { $ ('#' + type).append ($ ('<li>').text (text)); }
         ScrollTo ();
      }

      function clearSocketLog () {
         setHTML ('socketLog', '') 
      }

      function showError (text) {
         $ ('#socketLog').append ($ ('<li>').text ('!!! Error: ' + text).css ('color', 'red'));  // 
         ScrollTo();
      }
     
      function ScrollTo () {
         var el = document.getElementById ("argumentum");
         if (el) {
            var delta = el.offsetHeight + el.offsetTop - window.innerHeight;
            if (delta > -10) window.scrollTo(0, delta + 10); 
            // log(el.offsetHeight, el.offsetTop, window.innerHeight);
         }
      }

      function log () {
         var t = '', a; 
         for (var i = -1; ++i < arguments.length;) {
            var a = arguments[i];
            if (a && (typeof(a) == 'object')) {
               if (t) { console.log(t, a); } else { console.log(a);} 
               t = '';

            } else {
               t +=  (t ? ' :: ' : '') + a;
            }
         }
         if (t) console.log(t);
         // ??? show caller.line
      }

      function dict_ (A) {
         return (A === null || A === undefined) ? {} : (typeof A !== 'object') ? {}  : ('length' in A) ? {} : A;
      }

      function array_ (A) {
         return (A === null || A === undefined) ? [] : (typeof A !== 'object') ? [A] : ('length' in A) ? A : [A];
      }

    </script>
  </body>
</html>

